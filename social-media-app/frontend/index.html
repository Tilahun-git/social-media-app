<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Mini Social App with Comments</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f0f0f0;
      }
      h1 {
        text-align: center;
        color: #2c3e50;
      }
      .container {
        max-width: 700px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }
      button {
        background: #2ecc71;
        border: none;
        padding: 10px 15px;
        color: white;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 5px;
      }
      button:hover {
        background: #27ae60;
      }
      .post {
        border: 1px solid #ddd;
        background: #fafafa;
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
      }
      .post strong {
        color: #333;
      }
      .post img {
        max-width: 100%;
        margin-top: 10px;
        border-radius: 8px;
      }
      .comments {
        margin-top: 10px;
        padding-left: 15px;
        border-left: 2px solid #ccc;
        font-size: 0.9em;
      }
      .comment {
        margin-bottom: 5px;
      }
      .comment-input {
        display: flex;
        margin-top: 10px;
        gap: 10px;
      }
      .comment-input input {
        flex: 1;
        padding: 8px;
      }
    </style>
  </head>
  <body>
    <h1>Mini Social App with Comments</h1>

    <div class="container">
      <div id="auth-section">
        <input id="username" placeholder="Username" />
        <input id="password" type="password" placeholder="Password" />
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
      </div>

      <hr />

      <div id="post-section" style="display: none">
        <textarea
          id="postContent"
          placeholder="What's on your mind?"
        ></textarea>
        <input type="file" id="postImage" />
        <button onclick="addPost()">Post</button>
        <button onclick="logout()" style="background: #e74c3c">Logout</button>
      </div>

      <div id="posts"></div>
    </div>

    <script>
      // Replace this with your actual deployed backend URL on Render
      const API = "https://social-media-app-5-j2kt.onrender.com/api";

      // Register user
      async function register() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password) {
          return alert("Username and password are required.");
        }

        try {
          const res = await fetch(`${API}/auth/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to register");
          alert("Registered: " + data.username);
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Login user
      async function login() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password) {
          return alert("Username and password are required.");
        }

        try {
          const res = await fetch(`${API}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Login failed");

          localStorage.setItem("user", JSON.stringify(data));
          alert("Welcome, " + data.username + "!");
          showPostSection(true);
          loadPosts();
        } catch (error) {
          alert("Login failed: " + error.message);
        }
      }

      // Logout user
      function logout() {
        localStorage.removeItem("user");
        alert("Logged out");
        showPostSection(false);
        clearPosts();
      }

      // Show or hide post input section based on login
      function showPostSection(show) {
        document.getElementById("post-section").style.display = show
          ? "block"
          : "none";
        document.getElementById("auth-section").style.display = show
          ? "none"
          : "block";
      }

      // Add new post with optional image
      async function addPost() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) return alert("Please log in to post.");

        const content = document.getElementById("postContent").value.trim();
        const imageInput = document.getElementById("postImage");
        const imageFile = imageInput.files[0];

        if (!content && !imageFile)
          return alert("Post content or image is required.");

        try {
          const formData = new FormData();
          formData.append("author", user._id);
          formData.append("content", content);
          if (imageFile) formData.append("image", imageFile);

          const res = await fetch(`${API}/posts`, {
            method: "POST",
            body: formData,
          });

          const post = await res.json();
          if (!res.ok) throw new Error(post.error || "Failed to add post");

          document.getElementById("postContent").value = "";
          imageInput.value = null;
          loadPosts();
        } catch (error) {
          alert("Post error: " + error.message);
        }
      }

      // Load all posts
      async function loadPosts() {
        try {
          const res = await fetch(`${API}/posts`);
          if (!res.ok) throw new Error("Failed to load posts");
          const posts = await res.json();

          const container = document.getElementById("posts");
          container.innerHTML = "";

          posts.forEach((p) => {
            const div = document.createElement("div");
            div.className = "post";
            div.innerHTML = `
              <strong>${p.author.username}</strong>: ${p.content}
              ${
                p.image
                  ? `<br><img src="https://social-media-app-5-j2kt.onrender.com/uploads/${p.image}" alt="Post image">`
                  : ""
              }
              <div class="comments" id="comments-${p._id}"></div>

              <div class="comment-input">
                <input type="text" id="comment-input-${
                  p._id
                }" placeholder="Write a comment..." />
                <button onclick="addComment('${p._id}')">Comment</button>
              </div>
            `;
            container.appendChild(div);
            loadComments(p._id);
          });
        } catch (error) {
          alert(error.message);
        }
      }

      // Load comments for a post
      async function loadComments(postId) {
        try {
          const res = await fetch(`${API}/comments/post/${postId}`);
          if (!res.ok) throw new Error("Failed to load comments");
          const comments = await res.json();

          const container = document.getElementById(`comments-${postId}`);
          container.innerHTML = "";
          comments.forEach((c) => {
            const div = document.createElement("div");
            div.className = "comment";
            div.textContent = `${c.author.username}: ${c.content}`;
            container.appendChild(div);
          });
        } catch (error) {
          console.error(error);
        }
      }

      // Add comment to a post
      async function addComment(postId) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) return alert("Please log in to comment.");

        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        if (!content) return alert("Comment cannot be empty.");

        try {
          const res = await fetch(`${API}/comments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ author: user._id, post: postId, content }),
          });

          const comment = await res.json();
          if (!res.ok)
            throw new Error(comment.error || "Failed to add comment");

          input.value = "";
          loadComments(postId);
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // Clear posts from UI
      function clearPosts() {
        document.getElementById("posts").innerHTML = "";
      }

      // On page load, check if user is logged in
      window.onload = () => {
        if (localStorage.getItem("user")) {
          showPostSection(true);
          loadPosts();
        } else {
          showPostSection(false);
        }
      };
    </script>
  </body>
</html>
