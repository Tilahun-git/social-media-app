<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Mini Social App with Real-Time Chat</title>
    <link rel="icon" href="/favicon.ico" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f0f0;
        padding: 20px;
        box-sizing: border-box;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        font-size: 2rem;
        margin-bottom: 20px;
      }

      .container {
        max-width: 700px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px; /* space for chat */
      }

      input,
      textarea {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-size: 1rem;
      }

      button {
        background: #2ecc71;
        border: none;
        padding: 10px 15px;
        color: white;
        cursor: pointer;
        border-radius: 5px;
        font-size: 1rem;
        transition: background-color 0.3s;
      }

      button:hover {
        background: #27ae60;
      }

      .post {
        border: 1px solid #ddd;
        background: #fafafa;
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-size: 1rem;
      }

      .post img {
        max-width: 100%;
        margin-top: 10px;
        border-radius: 8px;
        max-height: 300px;
        object-fit: contain;
        cursor: pointer;
      }

      .comments {
        margin-top: 10px;
        padding-left: 15px;
        border-left: 2px solid #ccc;
        font-size: 0.9em;
      }

      .comment {
        margin: 5px 0;
      }

      .comment-input {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .comment-input input {
        flex: 1;
        padding: 8px;
        font-size: 1rem;
      }

      .delete-btn {
        background: #e74c3c;
        margin-left: 10px;
      }

      .delete-btn:hover {
        background: #c0392b;
      }

      /* Chat box fixed at bottom */
      #chat-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid #ccc;
        max-width: 700px;
        margin: auto;
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        border-radius: 10px 10px 0 0;
        box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
        font-size: 0.9rem;
        z-index: 1000;
      }

      #chat-messages {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        background: #fafafa;
        margin-bottom: 8px;
      }

      #chat-input-container {
        display: flex;
        gap: 10px;
      }

      #chat-input {
        flex: 1;
        padding: 8px;
        font-size: 1rem;
        border-radius: 5px;
        border: 1px solid #ccc;
      }

      #chat-send-btn {
        background: #3498db;
        border: none;
        padding: 10px 15px;
        color: white;
        cursor: pointer;
        border-radius: 5px;
        font-size: 1rem;
        transition: background-color 0.3s;
      }

      #chat-send-btn:hover {
        background: #2980b9;
      }

      @media (max-width: 480px) {
        body {
          padding: 8px;
        }

        h1 {
          font-size: 1.3rem;
          margin-bottom: 15px;
        }

        .container {
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 140px;
        }

        input,
        textarea {
          font-size: 0.95rem;
          padding: 8px;
        }

        button {
          font-size: 0.9rem;
          padding: 8px 12px;
          width: 100%;
          margin: 4px 0;
        }

        .comment-input {
          flex-direction: column;
          gap: 5px;
        }

        .post {
          font-size: 0.95rem;
          padding: 12px;
        }

        .comments {
          font-size: 0.85rem;
          padding-left: 10px;
        }

        .post img {
          max-height: 200px;
          object-fit: cover;
        }

        #chat-container {
          max-width: 100%;
          border-radius: 0;
          padding: 8px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <h1>Mini Social App</h1>
    <div class="container">
      <div id="auth-section">
        <input id="username" placeholder="Username" />
        <input id="password" type="password" placeholder="Password" />
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
      </div>

      <hr />

      <div id="post-section" style="display: none">
        <textarea
          id="postContent"
          placeholder="What's on your mind?"
        ></textarea>
        <input type="file" id="postImage" />
        <button onclick="addPost()">Post</button>
        <button onclick="logout()" class="delete-btn">Logout</button>
      </div>

      <div id="posts"></div>
    </div>

    <!-- Chat container -->
    <div id="chat-container" style="display: none">
      <div id="chat-messages"></div>
      <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type a message..." />
        <button id="chat-send-btn">Send</button>
      </div>
    </div>

    <!-- Load Socket.IO client -->
    <script
      src="https://cdn.socket.io/4.6.1/socket.io.min.js"
      integrity="sha384-/5sjyDCSjj+VRMqWW97HXVE/G+QqTFvlK7FYixhxmnCNPR8kZ0VzPyT6I8pAOXtq"
      crossorigin="anonymous"
    ></script>

    <script>
      const API = "https://social-media-app-5-j2kt.onrender.com/api";

      // Socket.IO client instance
      let socket;

      async function register() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password)
          return alert("Username and password required");

        const res = await fetch(`${API}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await res.json();
        if (data.error) return alert("Error: " + data.error);
        alert("Registered: " + data.username);
      }

      async function login() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password)
          return alert("Username and password required");

        const res = await fetch(`${API}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await res.json();
        if (data.error) return alert("Login failed: " + data.error);

        localStorage.setItem("user", JSON.stringify(data));
        alert("Welcome, " + data.username);
        showPostSection(true);
        loadPosts();
        initSocket(); // connect socket after login
        showChat(true);
      }

      function logout() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
        localStorage.removeItem("user");
        alert("Logged out");
        showPostSection(false);
        showChat(false);
        document.getElementById("posts").innerHTML = "";
        document.getElementById("chat-messages").innerHTML = "";
      }

      function showPostSection(show) {
        document.getElementById("post-section").style.display = show
          ? "block"
          : "none";
        document.getElementById("auth-section").style.display = show
          ? "none"
          : "block";
      }

      function showChat(show) {
        document.getElementById("chat-container").style.display = show
          ? "block"
          : "none";
      }

      async function addPost() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) return alert("Please log in");

        const content = document.getElementById("postContent").value.trim();
        const imageFile = document.getElementById("postImage").files[0];
        if (!content && !imageFile) return alert("Content or image required");

        const formData = new FormData();
        formData.append("author", user._id);
        formData.append("content", content);
        if (imageFile) formData.append("image", imageFile);

        const res = await fetch(`${API}/posts`, {
          method: "POST",
          body: formData,
        });

        const post = await res.json();
        if (post.error) return alert("Post error: " + post.error);

        document.getElementById("postContent").value = "";
        document.getElementById("postImage").value = null;

        prependPost(post, user);
      }

      function prependPost(p, user) {
        const container = document.getElementById("posts");
        const liked = p.likes?.includes(user?._id);

        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <strong>${p.author.username}</strong>: ${p.content}
          ${
            p.image
              ? `<br><img src="${API.replace("/api", "")}/uploads/${
                  p.image
                }" onclick="editImage('${p._id}')">`
              : ""
          }
          <div>
            <button onclick="toggleLike('${p._id}')">${
          liked ? "‚ù§Ô∏è Unlike" : "ü§ç Like"
        } (${p.likes.length || 0})</button>
            ${
              user._id !== p.author._id
                ? `<button onclick="followUser('${p.author._id}')" >‚ûï Follow</button>`
                : `<button onclick="editPost('${p._id}', \`${p.content}\`)">‚úèÔ∏è Edit</button>
                   <button onclick="deletePost('${p._id}')" class="delete-btn">üóëÔ∏è Delete</button>`
            }
          </div>
          <div class="comments" id="comments-${p._id}"></div>
          <div class="comment-input">
            <input type="text" id="comment-input-${
              p._id
            }" placeholder="Write a comment..." />
            <button onclick="addComment('${p._id}')">Comment</button>
          </div>
        `;
        container.prepend(div);

        loadComments(p._id);
      }

      async function loadPosts() {
        const user = JSON.parse(localStorage.getItem("user"));
        const res = await fetch(`${API}/posts`);
        const posts = await res.json();

        const container = document.getElementById("posts");
        container.innerHTML = "";

        posts.forEach((p) => {
          const liked = p.likes?.includes(user?._id);
          const div = document.createElement("div");
          div.className = "post";
          div.innerHTML = `
            <strong>${p.author.username}</strong>: ${p.content}
            ${
              p.image
                ? `<br><img src="${API.replace("/api", "")}/uploads/${
                    p.image
                  }" ${
                    user._id === p.author._id
                      ? `onclick="editImage('${p._id}')"`
                      : ""
                  }>`
                : ""
            }
            <div>
              <button onclick="toggleLike('${p._id}')">${
            liked ? "‚ù§Ô∏è Unlike" : "ü§ç Like"
          } (${p.likes.length})</button>
              ${
                user._id !== p.author._id
                  ? `<button onclick="followUser('${p.author._id}')">‚ûï Follow</button>`
                  : `<button onclick="editPost('${p._id}', \`${p.content}\`)">‚úèÔ∏è Edit</button>
                     <button onclick="deletePost('${p._id}')" class="delete-btn">üóëÔ∏è Delete</button>`
              }
            </div>
            <div class="comments" id="comments-${p._id}"></div>
            <div class="comment-input">
              <input type="text" id="comment-input-${
                p._id
              }" placeholder="Write a comment..." />
              <button onclick="addComment('${p._id}')">Comment</button>
            </div>
          `;
          container.appendChild(div);
          loadComments(p._id);
        });
      }

      // Follow/unfollow user by userId (author of post)
      async function followUser(userId) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) return alert("Please log in");

        try {
          const resFollow = await fetch(`${API}/follow`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ follower: user._id, following: userId }),
          });

          const data = await resFollow.json();
          if (data.error) return alert("Follow error: " + data.error);
          alert(data.unfollowed ? `Unfollowed user` : `Followed user`);
        } catch (err) {
          alert("Error: " + err.message);
        }
      }

      // Edit post text + image
      async function editPost(postId, currentContent) {
        const newContent = prompt("Edit your post:", currentContent);
        if (newContent === null) return;

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.onchange = async () => {
          const formData = new FormData();
          formData.append("content", newContent);
          if (fileInput.files[0]) {
            formData.append("image", fileInput.files[0]);
          }

          const res = await fetch(`${API}/posts/${postId}`, {
            method: "PUT",
            body: formData,
          });

          const data = await res.json();
          if (data.error) return alert("Edit failed: " + data.error);
          loadPosts();
        };

        fileInput.click();
      }

      // Edit image only (no text prompt)
      async function editImage(postId) {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.onchange = async () => {
          const formData = new FormData();
          formData.append("content", ""); // empty so content is not overwritten
          if (fileInput.files[0]) {
            formData.append("image", fileInput.files[0]);
          }

          const res = await fetch(`${API}/posts/${postId}`, {
            method: "PUT",
            body: formData,
          });

          const data = await res.json();
          if (data.error) return alert("Edit image failed: " + data.error);
          loadPosts();
        };

        fileInput.click();
      }

      async function deletePost(postId) {
        if (!confirm("Delete this post?")) return;

        const res = await fetch(`${API}/posts/${postId}`, {
          method: "DELETE",
        });

        const data = await res.json();
        if (data.error) return alert("Delete error: " + data.error);
        loadPosts();
      }

      async function toggleLike(postId) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) return alert("Log in to like");

        const res = await fetch(`${API}/posts/${postId}/like`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: user._id }),
        });

        const data = await res.json();
        if (data.error) return alert("Like error: " + data.error);
        loadPosts();
      }

      async function addComment(postId) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) return alert("Log in to comment");

        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        if (!content) return alert("Empty comment");

        const res = await fetch(`${API}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ author: user._id, post: postId, content }),
        });

        const data = await res.json();
        if (data.error) return alert("Comment error: " + data.error);

        input.value = "";
        loadComments(postId);
      }

      async function loadComments(postId) {
        const res = await fetch(`${API}/comments/post/${postId}`);
        const comments = await res.json();

        const container = document.getElementById(`comments-${postId}`);
        container.innerHTML = "";

        comments.forEach((c) => {
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `${c.author.username}: ${c.content}`;
          container.appendChild(div);
        });
      }

      // ---------------- SOCKET.IO CHAT -----------------

      function initSocket() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) return;

        socket = io("https://social-media-app-5-j2kt.onrender.com");

        socket.on("connect", () => {
          // Tell server who we are
          socket.emit("join", { userId: user._id, username: user.username });
        });

        socket.on("chatMessage", (msg) => {
          addChatMessage(msg);
        });

        // Optional: Handle disconnect, reconnect, errors here
      }

      // Add chat message to chat box
      function addChatMessage(msg) {
        const container = document.getElementById("chat-messages");
        const div = document.createElement("div");
        div.textContent = `${msg.username}: ${msg.text}`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      // Send chat message to server
      function sendChatMessage() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) {
          alert("Please log in to chat");
          return;
        }
        const input = document.getElementById("chat-input");
        const text = input.value.trim();
        if (!text) return;

        const msg = {
          userId: user._id,
          username: user.username,
          text,
          timestamp: Date.now(),
        };

        socket.emit("chatMessage", msg);
        input.value = "";
        addChatMessage(msg); // show immediately
      }

      document
        .getElementById("chat-send-btn")
        .addEventListener("click", sendChatMessage);
      document
        .getElementById("chat-input")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") sendChatMessage();
        });

      // -----------------------------------

      if (localStorage.getItem("user")) {
        showPostSection(true);
        loadPosts();
        showChat(true);
        initSocket();
      }
    </script>
  </body>
</html>
